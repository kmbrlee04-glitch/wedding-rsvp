<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: "Bookman Old Style", serif;
      background: white;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: brown;
    }

    .one-line {
      white-space: nowrap;
    }

    .green-text {
      color: green;
      font-weight: bold;
    }

    input[type="text"] {
      padding: 10px;
      width: 80%;
      max-width: 300px;
      margin: 10px 0;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      cursor: pointer;
      font-family: "Bookman Old Style", serif;
    }

    .beige-btn {
      background-color: #d8c4a0;
    }

    .cancel-btn {
      background-color: white;
      border: 1px solid #ccc;
    }

    .hidden {
      display: none;
    }

    .center {
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }

    .companion-row {
      margin: 5px 0;
    }
  </style>
</head>

<body>

  <h1>Wedding RSVP</h1>

  <!-- INSTRUCTIONS -->
  <div id="instructions">
    <p class="one-line">
      Please search for your name to
      <span class="green-text">CONFIRM YOUR RSVP</span>.
    </p>
    <p>If you cannot find your name, please contact us directly.</p>
  </div>

  <!-- STEP 1 -->
  <div id="step1" class="center">
    <input list="guestList" id="guestName" placeholder="Enter your name">
    <datalist id="guestList"></datalist>

    <button class="beige-btn" onclick="checkSeats()">ENTER</button>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="hidden center">
    <p id="seatText"></p>

    <div id="companions"></div>

    <button class="beige-btn" onclick="submitRSVP()">CONFIRM RSVP</button>
    <button class="cancel-btn" onclick="goHome()">CANCEL</button>
  </div>

  <!-- STEP 3 -->
  <div id="step3" class="hidden center">
    <h3>Thank you for confirming your RSVP!</h3>
    <button class="beige-btn" onclick="goHome()">RETURN TO HOME</button>
  </div>

<script>
  let reservedSeats = 0;
  let mainGuest = "";

  // Load guest names
  google.script.run.withSuccessHandler(function(names){
    const list = document.getElementById("guestList");
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      list.appendChild(opt);
    });
  }).getGuestNames();

  function checkSeats() {
    mainGuest = document.getElementById("guestName").value.trim();
    if (!mainGuest) return alert("Please enter your name.");

    google.script.run.withSuccessHandler(function(data){
      if (data.seats === "Not found") {
        alert("Name not found.");
        return;
      }

      reservedSeats = data.seats;

      document.getElementById("instructions").classList.add("hidden");
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");

      document.getElementById("seatText").innerText =
        `You have ${reservedSeats} RSVP(s) including YOU`;

      const container = document.getElementById("companions");
      container.innerHTML = "";

      for (let i = 1; i < reservedSeats; i++) {
        const div = document.createElement("div");
        div.className = "companion-row";
        div.innerHTML = `
          <input type="text" placeholder="Companion ${i} name">
          <label>
            <input type="checkbox" checked> Attending
          </label>
        `;
        container.appendChild(div);
      }

    }).getReservedSeats(mainGuest);
  }

  function submitRSVP() {
    const rows = document.querySelectorAll(".companion-row");
    let companions = [];

    rows.forEach(r => {
      const name = r.querySelector("input[type='text']").value.trim();
      const attend = r.querySelector("input[type='checkbox']").checked;
      if (name && attend) companions.push(name);
    });

    google.script.run.withSuccessHandler(function(){
      document.getElementById("step2").classList.add("hidden");
      document.getElementById("step3").classList.remove("hidden");
    }).saveRSVP({
      mainGuest: mainGuest,
      companions: companions,
      attending: true
    });
  }

  function goHome() {
    location.reload();
  }
</script>

</body>
</html>
